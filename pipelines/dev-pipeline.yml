trigger:
  branches:
    include:
      - features/*
      - feature/*
      - bugfix/*
      - bugfixes/*
      - hotfix/*
      - hotfixes/*

parameters:
  - name: buildConfiguration
    displayName: Build Configuration
    type: string
    default: 'Release'

variables:
  buildConfiguration: '${{ parameters.buildConfiguration }}'

stages:
- stage: BuildTest
  jobs:
  - job: BuildAndTest
    displayName: 'Build and Test Dev Branches'
    pool:
      name: 'Self-hosted'

    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '9.x'

    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet Packages'
      inputs:
        command: 'restore'
        projects: 'src/Calculator.sln'
        arguments: '--configuration $(buildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: 'Build Projects'
      inputs:
        command: 'build'
        projects: 'src/Calculator.sln'
        arguments: '--configuration $(buildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: 'Execute Unit Tests'
      inputs:
        command: 'test'
        projects: '**/*.Tests.*.csproj'
        arguments: '--configuration $(buildConfiguration) --collect:"XPlat Code Coverage"'
        
    - task: PublishTestResults@2
      displayName: 'Publish Test Results (.trx)'
      condition: succeededOrFailed()
      inputs:
        testResultsFiles: '**/TestResults/**/*.trx'
        searchFolder: '$(Agent.TempDirectory)'
        testResultsFormat: 'VSTest'
        mergeTestResults: true

    - task: PublishCodeCoverageResults@1
      displayName: 'Publish Code Coverage'
      condition: succeededOrFailed()
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(Agent.TempDirectory)/**/coverage.cobertura.xml'
        reportDirectory: '$(Agent.TempDirectory)'
